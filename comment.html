<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ニコニコ動画コメント取得</title>
</head>
<body>
    <h1>ニコニコ動画コメント取得</h1>
    <button id="downloadButton">コメントデータをダウンロード</button>

    <script>
        // カスタム例外
        class ThreadIdFetchError extends Error {
            constructor(message) {
                super(message);
                this.name = "ThreadIdFetchError";
            }
        }

        class ThreadKeyFetchError extends Error {
            constructor(message) {
                super(message);
                this.name = "ThreadKeyFetchError";
            }
        }

        // 動作を開始する関数
        function fetchData() {
            // 変数
            const url = "https://www.nicovideo.jp/watch/sm9"; // 取得先のURL
            const endpoint = "https://public.nvcomment.nicovideo.jp/v1/threads";

            // 正規表現でthreadIdとthreadKeyを抽出
            const threadIdRegex = /threadIds&quot;:\[\{&quot;id&quot;:(.*?),&quot;/;
            const threadKeyRegex = /{&quot;threadKey&quot;:&quot;(eyJ0eXAiOiJKV1Qi.*?)&quot;/;

            // 動画ページを取得
            fetch(url)
                .then(response => response.text())
                .then(videoPage => {
                    // threadIdとthreadKeyを抽出
                    const threadIdMatch = videoPage.match(threadIdRegex);
                    const threadKeyMatch = videoPage.match(threadKeyRegex);

                    const threadId = threadIdMatch ? threadIdMatch[1] : null;
                    const threadKey = threadKeyMatch ? threadKeyMatch[1] : null;

                    if (!threadId) {
                        throw new ThreadIdFetchError("threadIdの取得に失敗しました。");
                    }

                    if (!threadKey) {
                        throw new ThreadKeyFetchError("threadKeyの取得に失敗しました。");
                    }

                    // ペイロードの準備
                    const payload = {
                        params: {
                            targets: [
                                { id: threadId, fork: "owner" },
                                { id: threadId, fork: "main" },
                                { id: threadId, fork: "easy" }
                            ],
                            language: "ja-jp"
                        },
                        threadKey: threadKey,
                        additionals: {}
                    };

                    // リクエストの送信
                    const headers = {
                        "x-frontend-id": "6",
                        "Content-Type": "application/json"
                    };

                    return fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`エラー: ${response.status}`);
                    }
                })
                .then(threadResponse => {
                    // JSONレスポンスをダウンロード
                    const blob = new Blob([JSON.stringify(threadResponse, null, 4)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    // ダウンロード用のリンクを作成
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "thread_response.json"; // ダウンロードするファイル名
                    document.body.appendChild(a);
                    a.click(); // リンクをクリックしてダウンロードを開始
                    document.body.removeChild(a); // リンクを削除

                    // Blob URLを解放
                    URL.revokeObjectURL(url);

                    console.log("レスポンスがJSONとして保存されました");
                })
                .catch(error => {
                    console.error(error);
                });
        }

        // ボタンのクリックイベント
        document.getElementById('downloadButton').addEventListener('click', fetchData);
    </script>
</body>
</html>
